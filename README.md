# Pony

Pony lets you write gRPC methods in [jsonnet], e.g.

    // Greeter.Hello
    function(input) {
      response: {
        greeting: 'üê¥ : Hello ' + input.request.firstName,
      },
    }

The jsonnet method definitions can be updated in real time without restarting
pony.

Pony uses protobuf `FileDescriptorSets`, generated by `protoc` into `.pb` files,
as a description of valid gRPC method names, request and response types. Pony
does not need any further pre-generated or pre-compiled code.

[jsonnet]: https://jsonnet.org


## Usage

Generate a FileDescriptorSet for the services to stub with:

    protoc --descriptor_set_out service.pb --include_imports service.proto

Put jsonnet method definitions together in a directory, each file named
`<pkg>.<service>.<method>.jsonnet`. The jsonnet file is (re-)evaluated when the
gRPC server receives a call to that method.

The request protobuf message is marshaled to JSON and set as the `input` jsonnet
top-level argument when evaluating the jsonnet method. It is marshaled as:

    {
        request: { ...json-encoded gRPC request protobuf... }
    }

The jsonnet method definition should be a function of the following form:

    function(input) {
        response: { ...json-encoded gRPC response protobuf... }
    }

The response can reference fields of the input using regular jsonnet references.
See the [testdata samples](./testdata).

The `request` and `response` fields are encoded from/to protobuf messages
according to the [protojson] encoding rules.

To serve these jsonnet methods, run:

    pony serve --proto-set=service.pb --method-dir=dir


[protojson]: https://developers.google.com/protocol-buffers/docs/proto3#json


## Playing

Build and start pony on the test data:

    . ./bin/activate-hermit
    make install pb
    pony serve --proto-set testdata/all.pb --method-dir testdata

in a second terminal call it with

    client world

Experiment with the jsonnet method file in the [testdata](./testdata)
directory.

Alternatively there is a traditional generated gRPC server that the same client
can interact with. Start with:

    server


## Development

    . ./bin/activate-hermit
    make ci

Run `make help` for help on other make targets.
